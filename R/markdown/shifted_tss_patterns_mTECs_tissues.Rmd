---
title: "Shifted TSS patterns in mTECs vs. tissues"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
This script is used to calculate a list containing a matrix for each protein coding gene. The output list has the following properties:

* Only genes for which data was found in mTECs and tissues are included (n=16361).
* For each gene a matrix with the outlay below is calculated:

| | upstream of cds | cds | downstream of cds |
|------------- | ------------- | ------------- | ------------- |
|tissues  | numeric1 | numeric2 | numeric3 |
|mTECs  | numeric4 | numeric5 | numeric6 |

* The names of the list entries are the gene names. 

## Prerequisites
### Load libraries
```{r libraries, message=FALSE, eval=FALSE}
library(dplyr)
library(ggplot2)
library(TxDb.Hsapiens.UCSC.hg19.knownGene)
library(biomaRt)
library(reshape2)
```
### Define needed functions

This function is needed to preprocess input data to only contain positions of protein coding genes which are present in both data sets.

```{r functions}
preprocess_df <- function(x, keep) {
  x <- x[x$geneID %in% names(cds),]
  x <- x[x$geneID %in% keep,]
  x <- droplevels(x)
  x$geneID <- as.character(x$geneID)
  return(x)
}
```

### Read in data
Data Tables containing positions
```{r data tables, eval=FALSE}
#tra_genes n=5800
tra_genes <- read.table("/home/stroemic/hiwi_16/analysis/gene_lists/human_tra_genes_sansom.csv", header=TRUE, sep=",")
# all mTEC positions after randomForest filtering
mTEC_pos_fil <- read.table("/home/stroemic/hiwi_16/analysis/r_random-forest/filtered_data/all_mTECs.filtered.csv", header=TRUE, sep=",")
# all tissues (excluding thymus) positions after randomForest filtering
tissues_pos_fil <- read.table("/home/stroemic/hiwi_16/analysis/r_random-forest/filtered_data/all.tissues.wo.thymus.filtered.csv", header = TRUE, sep = ",")
# genes which are present in both, mTECs and tissues
keep <- intersect(mTEC_pos_fil$geneID, tissues_pos_fil$geneID)
```

BiomaRt and Txdb objects to define protein coding genes
```{r biomart and txdb, eval=FALSE}
##### BioMart object corresponding to hg19
ensembl <- useMart(biomart="ENSEMBL_MART_ENSEMBL", 
                   host="grch37.ensembl.org", 
                   dataset="hsapiens_gene_ensembl")

##### txdb object
my_chr = c("chr1", "chr2", "chr3", "chr4", "chr5", "chr6", "chr7", "chr8", "chr9", "chr10", "chr11", "chr12", "chr13", "chr14","chr15", "chr16", "chr17", "chr18", "chr19", "chr20", "chr21", "chr22", "chrM", "chrX", "chrY")
txdb <- TxDb.Hsapiens.UCSC.hg19.knownGene
seqlevels(txdb)<- my_chr
tx_genes <- genes(txdb) #get genes 
### keep only protein coding genes 
mart_gene_type <- getBM(attributes = c('entrezgene', 'gene_biotype'), 
                        filters = 'entrezgene',
                        values = names(tx_genes), 
                        mart=ensembl)
mart_gene_type <- mart_gene_type[grepl("protein_coding", mart_gene_type$gene_biotype, ignore.case = TRUE),] 
#subset of protein coding genes
tx_genes <- tx_genes[(elementMetadata(tx_genes)$gene_id %in% mart_gene_type$entrezgene)]
### sort by geneID
o <- order(as.numeric(tx_genes$gene_id))
tx_genes <- tx_genes[o]
```
GenomicRanges of coding region of protein coding genes
 
```{r cds, eval=FALSE}
##### txdb cds object
cds <- cdsBy(txdb, by="gene")
cds <- cds[names(cds) %in% mart_gene_type$entrezgene] #protein coding genes
cds <- cds[names(cds) %in% keep] #genes present in both, mTECs and tissues
oc <- order(as.numeric(names(cds))) #order by geneID
cds <- cds[oc]
# object containing all first cds entries, strand specific
first_cds = lapply(cds, function(x) if( unique(strand(x)) == '+') x[1] else x[length(x)])
first_cds = do.call(GRangesList, first_cds)
first_cds = unlist(first_cds)
# object containing all last cds entries, strand specific
last_cds = lapply(cds, function(x) if( unique(strand(x)) == '+') x[length(x)] else x[1])
last_cds = do.call(GRangesList, last_cds)
last_cds = unlist(last_cds)
```

## Analysis

```{r first steps, eval=FALSE}
#Dataframes only containing entries of protein coding genes which are present in keep
mTEC_pos_fil <- preprocess_df(mTEC_pos_fil, keep)
tissues_pos_fil <- preprocess_df(tissues_pos_fil, keep)

#built empty list with geneIDs as names of list
list_genes_names <- names(first_cds)
list_genes <- vector("list", length(list_genes_names))
names(list_genes) <- list_genes_names
```

The following loop builds fills up the empty list with a matrix for each gene containing tag counts for each TSS depending on location in 5'UTR, CDS, 3'UTR. The calculation consists of the following steps for each gene:

* built empty matrix
* get subset of mTEC and tissue dataframes containing only entries of respective gene
* loop over each position of gene in mTECs and add count to 5'UTR, CDS or 3'UTR depending on location
* loop over each position of gene in tissues and add count to 5'UTR, CDS or 3'UTR depending on location

Strand specific protocol, running time for 16361 genes with our data ~13h.

```{r matrices, eval=FALSE}
for (i in names(list_genes)) {
  print(i)
  #build matrix to write counts into 
  matrix_gene <- matrix(0, nrow=2, ncol=3)
  rownames(matrix_gene) <-c("tissues","mTEC") 
  colnames(matrix_gene) <-c("upstream","cds","downstream")
  #subdata frames for the gene
  mTEC_gene <- mTEC_pos_fil[mTEC_pos_fil$geneID == i,]
  tissues_gene <- tissues_pos_fil[tissues_pos_fil$geneID == i,]
  #iterate over all positions in mTEC data for the gene 
  for (pos_i in 1:nrow(mTEC_gene)) {
    #### keep in mind gene sense or antisense
    if (unique(strand(first_cds[i])) == '+'){
      #start and end of cds from cds objects
      start_cds <- start(first_cds[i])
      end_cds <- end(last_cds[i])
      #### counts in matrix according to position either in cds, upstream or downstream
      if ((mTEC_gene$start[pos_i] >= start_cds) & (mTEC_gene$start[pos_i] <= end_cds)) {
        matrix_gene["mTEC","cds"] <- matrix_gene["mTEC","cds"] + mTEC_gene$BarcodeCount[pos_i]
      } else if (mTEC_gene$start[pos_i] < start_cds) {
        matrix_gene["mTEC","upstream"] <- matrix_gene["mTEC","upstream"] + mTEC_gene$BarcodeCount[pos_i]
      } else {
        matrix_gene["mTEC","downstream"] <- matrix_gene["mTEC","downstream"] + mTEC_gene$BarcodeCount[pos_i]
      }
      
    } else {
      ## negative strand with different start and end 
      start_cds <- end(first_cds[i])
      end_cds <- start(last_cds[i])
      if ((mTEC_gene$start[pos_i] <= start_cds) & (mTEC_gene$start[pos_i] >= end_cds)) {
        matrix_gene["mTEC","cds"] <- matrix_gene["mTEC","cds"] + mTEC_gene$BarcodeCount[pos_i]
      } else if (mTEC_gene$start[pos_i] > start_cds) {
        matrix_gene["mTEC","upstream"] <- matrix_gene["mTEC","upstream"] + mTEC_gene$BarcodeCount[pos_i]
      } else { 
        matrix_gene["mTEC","downstream"] <- matrix_gene["mTEC","downstream"] + mTEC_gene$BarcodeCount[pos_i]
      }
    }
  }
  
  for (pos_j in 1:nrow(tissues_gene)) {
    #### keep in mind gene sense or antisense
    if (unique(strand(first_cds[i])) == '+'){
      #start and end of cds from cds objects
      start_cds <- start(first_cds[i])
      end_cds <- end(last_cds[i])
      #### counts in matrix according to position relative to start of cds
      if ((tissues_gene$start[pos_j] >= start_cds) & (tissues_gene$start[pos_j] <= end_cds) ) {
        matrix_gene["tissues","cds"] <- matrix_gene["tissues","cds"] + tissues_gene$BarcodeCount[pos_j]
      } else if(tissues_gene$start[pos_j] < start_cds) {
        matrix_gene["tissues","upstream"] <- matrix_gene["tissues","upstream"] + tissues_gene$BarcodeCount[pos_j]
      } else {
        matrix_gene["tissues","downstream"] <- matrix_gene["tissues","downstream"] + tissues_gene$BarcodeCount[pos_j]
      }

    } else {
      start_cds <- end(first_cds[i])
      end_cds <- start(last_cds[i])
      if ((tissues_gene$start[pos_j] <= start_cds) & (tissues_gene$start[pos_j] >= end_cds) )  {
        matrix_gene["tissues","cds"] <- matrix_gene["tissues","cds"] + tissues_gene$BarcodeCount[pos_j]
      } else if (tissues_gene$start[pos_j] > start_cds) {
        matrix_gene["tissues","upstream"] <- matrix_gene["tissues","upstream"] + tissues_gene$BarcodeCount[pos_j]
      } else {
        matrix_gene["tissues","downstream"] <- matrix_gene["tissues","downstream"] + tissues_gene$BarcodeCount[pos_j]
      }

    }
  }
  
  # set matrix on entry in list depending on geneID
  list_genes[[i]] <- matrix_gene
}
```

Finally save generated list with entries for each gene as rds.

```{r save rds, eval=FALSE}
saveRDS(list_genes, file="/home/stroemic/hiwi_16/analysis/shifted_TSS/list_genes_matrices_protein_coding.rds")
```

